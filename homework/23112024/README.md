Задача:
Реализовать knocking port
centralRouter может попасть на ssh inetrRouter через knock скрипт
Добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.
Запустить nginx на centralServer.
Пробросить 80й порт на inetRouter2 8080.
Дефолт в инет оставить через inetRouter.
Формат сдачи ДЗ - vagrant + ansible

Решение:
Для решения использовались статьи:

https://wiki.archlinux.org/title/Port_knocking#Simple_port_knocking

https://otus.ru/nest/post/267/

листинг iptables inetRouter
```
*nat
:PREROUTING ACCEPT [1:44]
:INPUT ACCEPT [1:44]
:OUTPUT ACCEPT [111:8672]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:TRAFFIC - [0:0]
:SSH-INPUT - [0:0]
:SSH-INPUTTWO - [0:0]

-A INPUT -p icmp --icmp-type 3 -j ACCEPT
-A INPUT -p icmp --icmp-type 8 -j ACCEPT
-A INPUT -p icmp --icmp-type 12 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 0 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 3 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 4 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 11 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 12 -j ACCEPT

# TRAFFIC chain for Port Knocking. The correct port sequence in this example is  8881 -> 7777 -> 9991; any other sequence will drop the traffic
-A INPUT -j TRAFFIC
-A TRAFFIC -p icmp --icmp-type any -j ACCEPT
-A TRAFFIC -m state --state ESTABLISHED,RELATED -j ACCEPT
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 22 -m recent --rcheck --seconds 15 --name SSH2 -j ACCEPT
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH2 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 9991 -m recent --rcheck --name SSH1 -j SSH-INPUTTWO
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH1 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 7777 -m recent --rcheck --name SSH0 -j SSH-INPUT
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH0 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 8881 -m recent --name SSH0 --set -j DROP
-A SSH-INPUT -m recent --name SSH1 --set -j DROP
-A SSH-INPUTTWO -m recent --name SSH2 --set -j DROP
-A TRAFFIC -j DROP
COMMIT
# END or further rules
```

листинг iptables inetRouter2
```
*filter
:INPUT ACCEPT [222:17823]
:FORWARD ACCEPT [4:509]
:OUTPUT ACCEPT [160:14623]
-A FORWARD -d 192.168.0.2/32 -p tcp -m tcp --dport 80 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Mon May  1 15:26:15 2023
# Generated by iptables-save v1.4.21 on Mon May  1 15:26:15 2023
*nat
:PREROUTING ACCEPT [3:472]
:INPUT ACCEPT [3:472]
:OUTPUT ACCEPT [80:6306]
:POSTROUTING ACCEPT [1:60]
-A PREROUTING -i eth2 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 192.168.0.2:80
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
```

скрипт для knocking port
```
#!/bin/bash
HOST=$1
shift
for ARG in "$@"
do
        sudo nmap -Pn --max-retries 0 -p $ARG $HOST
done
```

Проверяем port knocking
```
[root@centralRouter ~]# /vagrant/knock_scr.sh 192.168.255.1 8881 7777 9991

Starting Nmap 6.40 ( http://nmap.org ) at 2023-05-01 18:03 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for 192.168.255.1
Host is up (0.00074s latency).
PORT     STATE    SERVICE
8881/tcp filtered unknown
MAC Address: 08:00:27:93:B2:D9 (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 0.36 seconds

Starting Nmap 6.40 ( http://nmap.org ) at 2023-05-01 18:03 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for 192.168.255.1
Host is up (0.00054s latency).
PORT     STATE    SERVICE
7777/tcp filtered cbt
MAC Address: 08:00:27:93:B2:D9 (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 0.34 seconds

Starting Nmap 6.40 ( http://nmap.org ) at 2023-05-01 18:03 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for 192.168.255.1
Host is up (0.00051s latency).
PORT     STATE    SERVICE
9991/tcp filtered issa
MAC Address: 08:00:27:93:B2:D9 (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 0.35 seconds
```

2-4 Проверяю проброс до nginx с локалхоста
```
root@ubuntu:~# curl 192.168.11.121:8080

Check mapping inetRouter2:8080 to centralServer:80 success!
```

Используем ansible-playbook
```
- name: ConfigcentralServer
  hosts: centralServer
  become: true

  tasks:
    - name: Enable EPEL Repository on CentOS 7
      yum:
       name: epel-release
       state: latest

    - name: install Services
      yum:
        name:
        - vim
        - iptables
        - tcpdump
        - net-tools
        - iptables-services
        - traceroute
        - nmap
        - nginx
        state: present
        update_cache: true


    - name: change config
      ansible.builtin.lineinfile:
       path: /usr/share/nginx/html/index.html
       line: 'Check mapping inetRouter2:8080 to centralServer:80 success!'

    - name: start nginx
      service:
        name: nginx
        state: started
        enabled: yes


    - name: disable default route
      ansible.builtin.lineinfile:
       path: /etc/sysconfig/network-scripts/ifcfg-eth0
       line: DEFROUTE=no

    - name: default route
      ansible.builtin.shell: |
        echo "GATEWAY=192.168.0.1" >> /etc/sysconfig/network-scripts/ifcfg-eth1
```

Проверяем что идём в интернет по дефолтному маршруту

```
[root@centralServer ~]# traceroute -I google.com
traceroute to google.com (108.177.14.101), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  0.509 ms  0.462 ms  0.590 ms
 2  192.168.255.1 (192.168.255.1)  1.125 ms  1.210 ms  1.494 ms
 3  192.168.11.1 (192.168.11.1)  40.734 ms  40.760 ms  40.656 ms
 4  5.101.110.7 (5.101.110.7)  41.557 ms  42.129 ms  42.021 ms
 5  143.244.192.34 (143.244.192.34)  41.761 ms 143.244.192.24 (143.244.192.24)  41.799 ms 143.244.192.28 (143.244.192.28)  41.792 ms
 6  143.244.224.84 (143.244.224.84)  42.116 ms 143.244.224.82 (143.244.224.82)  42.067 ms 143.244.224.74 (143.244.224.74)  42.046 ms
 7  143.244.224.73 (143.244.224.73)  41.815 ms 143.244.224.79 (143.244.224.79)  41.109 ms 143.244.224.73 (143.244.224.73)  41.006 ms
 8  142.250.170.160 (142.250.170.160)  43.241 ms  42.722 ms  42.575 ms
 9  74.125.242.187 (74.125.242.187)  41.800 ms * *
 10 172.253.66.186 (172.253.66.186)  42.111 ms 142.251.225.137 (142.251.225.137)  40.953 ms 142.251.225.135 (142.251.225.135)  40.936 ms 
 11 ams15s48-in-f14.1e100.net (142.251.39.110)  41.056 ms  41.179 ms 74.125.243.82 (74.125.243.82)  41.404 ms
```
